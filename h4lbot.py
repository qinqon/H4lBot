#!/usr/bin/env python
import sys
import time
import pprint
import telepot
import random
import datetime
import json
import cv2
import urllib2
import numpy as np
import sys
import os
import argparse

from tinydb import TinyDB, Query

def get_cam_shot():
    host = "192.168.1.128:8081"
    camshot = "/tmp/camshot.avi"
    hoststr = 'http://' + host + '/video'
    
    # Define the codec and create VideoWriter object
    fourcc = cv2.cv.CV_FOURCC(*'XVID')
    out = cv2.VideoWriter(camshot,fourcc, 20.0, (640,480))
    
    stream=urllib2.urlopen(hoststr)
    bytes=''
    frame_count = 100
    while frame_count > 0:
        bytes+=stream.read(1024)
        a = bytes.find('\xff\xd8')
        b = bytes.find('\xff\xd9')
        if a != -1 and b != -1:
            frame_count -= 1
            jpg = bytes[a:b+2]
            bytes= bytes[b+2:]
            capture = cv2.imdecode(np.fromstring(jpg, dtype=np.uint8),cv2.CV_LOAD_IMAGE_COLOR)
            out.write(capture)
    out.release()
    return open(camshot, 'rb')

class commands:
    addmovie, addmusic, addtorrent, camshot, unknown= range(5)

def show_wishlist(chat_id, media_type):
    bot.sendMessage(chat_id, "This is the " + media_type + " wishlist:")
    wishlist = Query()
    rows = db.search(wishlist.type == media_type)
    message = ""
    for row in rows:
        message += row['name'] + "\n"
    bot.sendMessage(chat_id, message)

def add_to_wishlist(chat_id, media_type, values):
    for value in values.split("\n"):
        db.insert({'type': media_type, 'name': value})
    bot.sendMessage(chat_id, media_type + " succesfully added.")

def handle(msg):
    global current_command
    global db 
    global args
    content_type, chat_type, chat_id = telepot.glance(msg) 
    user_id=msg['from']['id']
    if user_id != args.user_id:
        bot.sendMessage(chat_id, "Go away stalker !!!")
        return
    if (content_type == 'text'):
        text    = msg['text']
        if text == '/callbasilio':
            bot.sendMessage(chat_id, "Say something to Basilio")
            current_command = commands.camshot
        elif text == '/addmovie':
            bot.sendMessage(chat_id, "Send me a movie you want to add to the wishlist")
            current_command = commands.addmovie
        elif text == '/addmusic':
            bot.sendMessage(chat_id, "Send me some music you want to add to the wishlist")
            current_command = commands.addmusic
        elif text == '/addtorrent':
            bot.sendMessage(chat_id, "Send me a torrent you want to add to the download queue")
            current_command = commands.addtorrent
        elif text == '/showmusic':
            show_wishlist(chat_id, 'music')
        elif text == '/showmovies':
            show_wishlist(chat_id, 'movie')
        elif current_command != commands.unknown: 
            if current_command == commands.addmovie:
                add_to_wishlist(chat_id, 'movie', text)
            elif current_command == commands.addmusic:
                add_to_wishlist(chat_id, 'music', text)
            current_command = commands.unknown
    elif (content_type == 'voice'):
        if current_command == commands.camshot:
            file_id = msg['voice']['file_id']
            bot.download_file(file_id, '/tmp/hi.ogg')
            os.system("cvlc --play-and-exit -A alsa --alsa-audio-device hw:1,7  /tmp/hi.ogg")
            bot.sendMessage(chat_id, "Waitting for Basilio... be patient my friend")
            bot.sendVideo(chat_id, get_cam_shot())
        current_command = commands.unknown

parser = argparse.ArgumentParser(description='Instagram bot for HAL operations.')
parser.add_argument("token", help="Telegram bot token string as generated by BotFather")
parser.add_argument("db_path", help="Directory to store the database db.json file")
parser.add_argument("user_id", help="Telegram user ID to restrict the bot", type=int)
parser.parse_args()
args = parser.parse_args()

# Getting the token from command-line is better than embedding it in code,
# because tokens are supposed to be kept secret.

db = TinyDB(args.db_path + '/db.json')

current_command = commands.unknown
bot = telepot.Bot(args.token)
bot.message_loop(handle)
print ('Listening ...')


# Keep the program running.
while 1:
	time.sleep(10)
